(this["webpackJsonp@magnit/frontend"]=this["webpackJsonp@magnit/frontend"]||[]).push([[13],{306:function(t,e,n){"use strict";n.d(e,"a",(function(){return o}));var r=n(9),a=n(102),c=n(222),o=(n(0),function(t){var e=t.onClose,n=t.open,o=t.width,s=t.children;return Object(r.jsx)(a.a,{open:!!n,onClose:e},Object(r.jsx)("div",{css:function(t){return{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",padding:t.spacing(6),maxWidth:"100%",backgroundColor:t.colors.white,width:o||t.spacing(6),borderRadius:6}}},Object(r.jsx)("div",{css:function(t){return{fontSize:t.fontSize.xxLarge,position:"absolute",top:"-.5em",right:"-.5em",color:t.colors.white,backgroundColor:t.colors.gray,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",width:"1em",height:"1em",cursor:"pointer"}},onClick:e},Object(r.jsx)(c.a,{css:function(t){return{fontSize:t.fontSize.small}}})),s))});o.displayName="SimpleModal"},315:function(t,e,n){"use strict";n.r(e);var r=n(8),a=n.n(r),c=n(11),o=n(104),s=n(26),u=n(9),i=n(246),f=n(247),l=n(50),b=n(307),j=n(289),p=n(294),O=n(293),m=n(236),d=n(298),h=n(229),S=n(29),k=n(306),g=n(302),x=n(303),y=n(0),E=function(t){var e=t.onSubmit,n=Object(y.useState)(""),r=Object(s.a)(n,2),a=r[0],c=r[1],o=Object(y.useState)(""),f=Object(s.a)(o,2),b=f[0],p=f[1],O=Object(y.useCallback)((function(t){t.preventDefault(),e&&e(a,b)}),[a,b,e]);return Object(u.jsx)("form",{action:"",onSubmit:O},Object(u.jsx)(j.a,{container:!0},Object(u.jsx)(j.a,{item:!0,xs:12,css:function(t){return{fontSize:t.fontSize.larger,marginBottom:t.spacing(2)}}},"\u041d\u043e\u0432\u043e\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435"),Object(u.jsx)(j.a,{item:!0,xs:12},Object(u.jsx)(i.InputField,{onChange:function(t){c(t.target.value)},value:a,placeholder:"\u0417\u0430\u0433\u043e\u043b\u043e\u0432\u043e\u043a",autoFocus:!0,type:"text",required:!0,fullWidth:!0})),Object(u.jsx)(j.a,{item:!0,xs:12},Object(u.jsx)(i.InputField,{onChange:function(t){p(t.target.value)},value:b,placeholder:"\u0422\u0435\u043a\u0441\u0442 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f",autoFocus:!0,type:"text",required:!0,fullWidth:!0,multiline:!0})),Object(u.jsx)(j.a,{item:!0,xs:12},Object(u.jsx)(i.Button,{type:"submit",css:function(t){return{display:"flex",margin:"".concat(t.spacing(6)," auto 0")}}},Object(u.jsx)(l.SendIcon,null),"\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c"))))};E.displayName="SendMessageForm";var v=n(85),C=n(52);function T(t,e){return(T=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function R(t){return(R=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function w(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function D(t){return(D="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function F(t,e){return!e||"object"!==D(e)&&"function"!==typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function P(t,e,n){return(P=w()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);var a=new(Function.bind.apply(t,r));return n&&T(a,n.prototype),a}).apply(null,arguments)}function N(t){var e="function"===typeof Map?new Map:void 0;return(N=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!==typeof t)throw new TypeError("Super expression must either be null or a function");if("undefined"!==typeof e){if(e.has(t))return e.get(t);e.set(t,r)}function r(){return P(t,arguments,R(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),T(r,t)})(t)}var _=function(t){!function(t,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&T(t,e)}(r,t);var e,n=(e=r,function(){var t,n=R(e);if(w()){var r=R(this).constructor;t=Reflect.construct(n,arguments,r)}else t=n.apply(this,arguments);return F(this,t)});function r(){return Object(C.a)(this,r),n.apply(this,arguments)}return r}(N(Error)),A=n(27),I=n.n(A),M=n(35);e.default=function(t){var e=t.taskId,n=t.users,r=Object(y.useContext)(v.a),C=Object(y.useState)(null),T=Object(s.a)(C,2),R=T[0],w=T[1],D=Object(y.useState)([]),F=Object(s.a)(D,2),P=F[0],N=F[1],A=Object(y.useState)(!1),G=Object(s.a)(A,2),W=G[0],B=G[1],L=Object(y.useState)({id:0,title:"",templates:[],stages:[],documents:[],marketplace:{address:"",city:"",format:"",region:""},status:f.ETaskStatus.DRAFT}),H=Object(s.a)(L,2),K=H[0],q=H[1],J=Object(y.useState)({trigger:!1,to:""}),X=Object(s.a)(J,2),Y=X[0],Q=X[1],U=Object(y.useState)([]),V=Object(s.a)(U,2),Z=V[0],$=V[1],tt=Object(y.useState)([]),et=Object(s.a)(tt,2),nt=et[0],rt=et[1],at=Object(y.useState)([]),ct=Object(s.a)(at,2),ot=ct[0],st=ct[1],ut=Object(y.useState)([]),it=Object(s.a)(ut,2),ft=it[0],lt=it[1],bt=(K.marketplace||{}).region,jt=(K.marketplace||{}).city,pt=(K.marketplace||{}).format,Ot=function(t){return I.a.has(t,"id")&&I.a.has(t,"title")&&I.a.has(t,"templates")&&I.a.has(t,"stages")},mt=Object(y.useRef)([]),dt=function(t){return t.status!==f.ETaskStatus.IN_PROGRESS&&t.status!==f.ETaskStatus.COMPLETED},ht=Object(y.useCallback)((function(t){if(Ot(t.task))return mt.current=I.a.cloneDeep(t.task.stages),q(Object(o.a)({},t.task)),t.task}),[]),St=Object(y.useCallback)((function(t,e){Object(M.getFormatsForCity)(r.courier,t,e).then((function(t){return st(t.formats)})).catch(console.error)}),[r.courier]),kt=Object(y.useCallback)((function(){Object(M.getAllRegions)(r.courier).then((function(t){return $(t.regions)})).catch(console.error)}),[r.courier]),gt=Object(y.useCallback)((function(t){Object(M.getCitiesForRegion)(r.courier,t).then((function(t){return rt(t.cities)})).catch(console.error)}),[r.courier]),xt=Object(y.useCallback)((function(t,e,n){Object(M.getAddressesForFormat)(r.courier,t,e,n).then((function(t){return lt(t.addresses)})).catch(console.error)}),[r.courier]);function yt(t,e){var n=[];t.templates.forEach((function(t){return n.push(t)})),n.forEach((function(t,n,r){var a=e.templates.find((function(e){return e.id===t.id}));a&&(r[n]=I.a.merge(t,a))})),N([].concat(n))}var Et=Object(y.useCallback)((function(){Object(M.getTaskExtended)(r.courier,I.a.toNumber(e)).then(ht).then(function(){var t=Object(c.a)(a.a.mark((function t(e){var n,c,o,s;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e&&dt(e)){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,Object(M.getTemplates)(r.courier);case 4:if(yt(t.sent,e),!e.marketplace){t.next=10;break}return n=e.marketplace,c=n.city,o=n.region,s=n.format,t.next=10,Promise.all([kt(),gt(o),St(o,c),xt(o,c,s)]).catch(console.error);case 10:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()).catch(console.error)}),[r.courier,xt,gt,St,kt,ht,e]),vt=Object(y.useRef)(null);Object(y.useEffect)((function(){vt.current!==e&&(vt.current=e,Et())}),[Et,e]),Object(y.useEffect)((function(){K.status===f.ETaskStatus.DRAFT&&kt()}),[kt,K.status]);var Ct=Object(y.useRef)(bt);Object(y.useEffect)((function(){bt&&Ct.current!==bt&&gt(bt)}),[gt,bt]);var Tt=Object(y.useRef)(jt);Object(y.useEffect)((function(){jt&&bt&&Tt.current!==jt&&St(bt,jt)}),[bt,jt,St]);var Rt=Object(y.useRef)(pt);function wt(){w(null)}Object(y.useEffect)((function(){jt&&bt&&pt&&Rt.current!==pt&&xt(bt,jt,pt)}),[pt,bt,jt,xt]);var Dt=Object(y.useCallback)(function(){var t=Object(c.a)(a.a.mark((function t(n){var c,s,u;return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(c=function(t){return!mt.current.find((function(e){return e.id===t.id}))},s=function(t){return t.title&&t.deadline},u=n.stages.filter(c).filter(s).map((function(t){var e=t.deadline.split("."),n=new Date;return n.setDate(Number(I.a.first(e))),n.setMonth(Number(I.a.nth(e,1))-1),n.setFullYear(Number(I.a.nth(e,2))),Object(o.a)(Object(o.a)({},t),{},{deadline:new Date(n).toISOString()})})),n.stages.filter((function(t){return t.title&&t.deadline})).length+u.length!==0){t.next=6;break}throw new _;case 6:if(u.length){t.next=8;break}return t.abrupt("return");case 8:return t.abrupt("return",Object(M.addStages)(r.courier,e,u));case 9:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),[r.courier,e]),Ft=Object(y.useCallback)((function(){var t=K.status;if(dt(K)){K.status!==f.ETaskStatus.DRAFT&&K.status!==f.ETaskStatus.ON_CHECK&&K.status!==f.ETaskStatus.EXPIRED||(K.status=f.ETaskStatus.IN_PROGRESS);var n=function(t){var n=t.id,a=t.editable;return Object(M.updateTemplateAssignment)(r.courier,e,Number(n),{editable:a})},a=(K.templates||[]).filter((function(t){return P.find((function(e){return e.id===t.id}))})).map((function(t){return Number(t.id)}));Promise.all([Object(M.addTemplateAssignment)(r.courier,Number(e),a).then((function(){return Promise.all(K.templates.map(n))})),Dt(K)]).then((function(){return Object(M.updateTask)(r.courier,e,z(K))})).then((function(){Et(),r.setSnackbarState({open:!0,message:"\u0417\u0430\u0434\u0430\u043d\u0438\u0435 \u0443\u0441\u043f\u0435\u0448\u043d\u043e \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u043e"})})).catch((function(e){K.status=t;var n="\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c \u0437\u0430\u0434\u0430\u043d\u0438\u0435";e instanceof _&&(n="\u0417\u0430\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0435 \u044d\u0442\u0430\u043f\u043e\u0432 \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u043e"),r.setSnackbarState({open:!0,message:n}),r.setSnackbarError(!0)}))}}),[Dt,r,K,e,P,Et]);var Pt=Object(y.useCallback)((function(t){Object(M.addTaskDocument)(r.courier,e,t).then((function(){return Et()})).catch((function(){r.setSnackbarState({open:!0,message:"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0444\u0430\u0439\u043b"}),r.setSnackbarError(!0)}))}),[r,e,Et]),Nt=Object(y.useCallback)((function(t){Object(M.deleteTaskDocument)(r.courier,e,t).then((function(){return Et()})).catch((function(){r.setSnackbarState({open:!0,message:"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0444\u0430\u0439\u043b"}),r.setSnackbarError(!0)}))}),[r,e,Et]),_t=Object(y.useCallback)((function(t){Object(M.addComment)(r.courier,e,t.idAssignment,t.text).then((function(){return Et()})).catch((function(){r.setSnackbarState({open:!0,message:"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439"}),r.setSnackbarError(!0)}))}),[r,e,Et]),At=Object(y.useCallback)((function(t){Object(M.deleteComment)(r.courier,e,t).then((function(){return Et()})).catch((function(){r.setSnackbarState({open:!0,message:"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439"}),r.setSnackbarError(!0)}))}),[r,e,Et]);return Object(u.jsx)(g.a,null,Object(u.jsx)(k.a,{width:370,open:W,onClose:function(){B(!1)}},Object(u.jsx)(E,{onSubmit:function(t,e){Object(M.sendPushToken)(r.courier,{title:t,body:e}).then((function(){B(!1),r.setSnackbarState({open:!0,message:"\u0421\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435 \u0443\u0441\u043f\u0435\u0448\u043d\u043e \u043e\u0442\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u043e"})})).catch((function(){B(!1),r.setSnackbarState({open:!0,message:"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0443"}),r.setSnackbarError(!0)}))}})),Y.trigger&&Object(u.jsx)(S.Redirect,{to:Y.to,noThrow:!0}),Object(u.jsx)(x.a,{title:"\u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f \u043e \u0437\u0430\u0434\u0430\u043d\u0438\u0438"},Object(u.jsx)(j.a,{item:!0},Object(u.jsx)(j.a,{container:!0},Object(u.jsx)(j.a,{item:!0},dt(K)&&Object(u.jsx)(i.Button,{variant:"contained",scheme:"blue",css:function(t){return{margin:"0 ".concat(t.spacing(1))}},onClick:Ft},Object(u.jsx)(l.SendIcon,null),Object(u.jsx)(p.a,null,"\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c"))),K.status!==f.ETaskStatus.DRAFT&&Object(u.jsx)(y.Fragment,null,Object(u.jsx)(j.a,{item:!0},Object(u.jsx)(O.a,{onClick:function(t){w(t.currentTarget)}},Object(u.jsx)(h.a,null))),Object(u.jsx)(m.a,{keepMounted:!0,open:Boolean(R),anchorEl:R,onClose:wt},Object(u.jsx)(d.a,{onClick:function(){Q({to:"/tasks/".concat(e,"/report"),trigger:!0}),wt()}},"\u041f\u043e\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u043e\u0442\u0447\u0435\u0442"),Object(u.jsx)(d.a,{onClick:function(){Q({to:"/tasks/".concat(e,"/history"),trigger:!0}),wt()}},"\u041f\u043e\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u0438\u0441\u0442\u043e\u0440\u0438\u044e"),K.status===f.ETaskStatus.IN_PROGRESS&&Object(u.jsx)(d.a,{onClick:function(){K.status===f.ETaskStatus.IN_PROGRESS&&(K.status=f.ETaskStatus.ON_CHECK),Object(M.updateTask)(r.courier,e,z(K)).then((function(){Et(),r.setSnackbarState({open:!0,message:"\u0417\u0430\u0434\u0430\u043d\u0438\u0435 \u0443\u0441\u043f\u0435\u0448\u043d\u043e \u043e\u0442\u043e\u0437\u0432\u0430\u043d\u043e"})})).catch((function(){r.setSnackbarState({open:!0,message:"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u043e\u0442\u043e\u0437\u0432\u0430\u0442\u044c \u0437\u0430\u0434\u0430\u043d\u0438\u0435"}),r.setSnackbarError(!0)})),wt()}},"\u041e\u0442\u043e\u0437\u0432\u0430\u0442\u044c \u0437\u0430\u0434\u0430\u043d\u0438\u0435"),K.status!==f.ETaskStatus.COMPLETED&&Object(u.jsx)(d.a,{onClick:function(){K.status!==f.ETaskStatus.IN_PROGRESS&&K.status!==f.ETaskStatus.ON_CHECK||(K.status=f.ETaskStatus.COMPLETED),Object(M.updateTask)(r.courier,e,z(K)).then((function(){Et(),r.setSnackbarState({open:!0,message:"\u0417\u0430\u0434\u0430\u043d\u0438\u0435 \u0443\u0441\u043f\u0435\u0448\u043d\u043e \u0437\u0432\u0435\u0440\u0448\u0435\u043d\u043e"})})).catch((function(){r.setSnackbarState({open:!0,message:"\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u044c \u0437\u0430\u0434\u0430\u043d\u0438\u0435"}),r.setSnackbarError(!0)})),wt()}},"\u0417\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u044c \u0437\u0430\u0434\u0430\u043d\u0438\u0435"),Object(u.jsx)(d.a,{onClick:function(){wt(),B(!0)}},"\u041e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435")))))),Object(u.jsx)(j.a,{css:function(t){return{maxWidth:t.maxTemplateWidth,margin:t.spacing(4),position:"relative"}}},Object(u.jsx)(b.TaskEditor,{users:n,task:K,regions:Z,cities:nt,formats:ot,addresses:ft,templates:dt(K)?P:K.templates,variant:"view",onTaskChange:function(t){Ot(t)&&q(Object(o.a)({},t))},onDeleteAsset:Nt,onAddAsset:Pt,onAddComment:_t,onDeleteComment:At})))};function z(t){return I.a.omit(t,["id","templates","stages","documents"])}}}]);
//# sourceMappingURL=13.22293346.chunk.js.map