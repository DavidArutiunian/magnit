# build step
FROM node:10-alpine AS build

WORKDIR /devel

COPY package.json .
COPY yarn.lock .
COPY packages/backend/package.json packages/backend/package.json

RUN yarn install

COPY . .

RUN yarn build:backend

# serve step
FROM node:10-alpine AS serve

WORKDIR /var/www/magnit

COPY --from=build /devel/packages/backend/dist dist
COPY --from=build /devel/node_modules node_modules
COPY --from=build /devel/packages/backend/node_modules node_modules

ENTRYPOINT ["node", "dist/main.js"]
